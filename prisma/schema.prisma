// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USER AND AUTHENTICATION MODELS
// =============================================================================

/// User model for authentication
/// Uses email-based OTP authentication (no passwords)
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  firstName     String?
  lastName      String?
  phone         String?
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  otpCodes      OTPCode[]
  sessions      Session[]
  applications  Application[]
  auditLogs     AuditLog[]    @relation("UserAuditLogs")
  adminActions  AuditLog[]    @relation("AdminAuditLogs")

  @@index([email])
  @@index([role])
}

/// User roles for authorization
enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

/// OTP codes for email-based authentication
model OTPCode {
  id        String      @id @default(uuid())
  code      String
  type      OTPType     @default(LOGIN)
  expiresAt DateTime
  used      Boolean     @default(false)
  usedAt    DateTime?
  attempts  Int         @default(0)
  createdAt DateTime    @default(now())

  // Relations
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, code])
  @@index([expiresAt])
}

/// OTP types for different purposes
enum OTPType {
  LOGIN
  VERIFY_EMAIL
  ACCOUNT_RECOVERY
}

/// User sessions for JWT management
model Session {
  id           String    @id @default(uuid())
  token        String    @unique
  refreshToken String?   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  isValid      Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// =============================================================================
// APPLICATION MODELS FOR 2026 SEASON
// =============================================================================

/// Student applications for FIRST Global Team Kenya 2026
model Application {
  id              String            @id @default(uuid())
  season          String            @default("2026")
  status          ApplicationStatus @default(DRAFT)
  
  // Personal Information
  firstName       String
  lastName        String
  email           String
  phone           String
  dateOfBirth     DateTime
  gender          String?
  nationality     String            @default("Kenyan")
  
  // Educational Information
  school          String
  grade           String
  county          String
  
  // Experience & Interest
  experience      ExperienceLevel
   interests       Json              // JSON array of interest IDs
   motivation      String
  
  // Additional Information
  previouslyApplied Boolean         @default(false)
  hearAboutUs     String?
   additionalInfo  String?
  
  // Documents (URLs to uploaded files)
  resumeUrl       String?
  recommendationUrl String?
  
  // Consent
  parentConsent   Boolean           @default(false)
  termsAccepted   Boolean           @default(false)
  parentEmail     String?
  parentPhone     String?
  
  // Admin Review
   reviewNotes     String?
  reviewedBy      String?
  reviewedAt      DateTime?
  interviewDate   DateTime?
   interviewNotes  String?
  finalScore      Float?
  
  // Timestamps
  submittedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  statusHistory   ApplicationStatusHistory[]

  @@unique([userId, season])
  @@index([status])
  @@index([season])
  @@index([submittedAt])
}

/// Application status values
enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  SHORTLISTED
  INTERVIEW_SCHEDULED
  INTERVIEWED
  ACCEPTED
  REJECTED
  WAITLISTED
  WITHDRAWN
}

/// Experience levels for applicants
enum ExperienceLevel {
  NONE
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

/// Track application status changes
model ApplicationStatusHistory {
  id            String            @id @default(uuid())
  previousStatus ApplicationStatus?
  newStatus     ApplicationStatus
   notes         String?
  changedBy     String?           // Admin user ID
  createdAt     DateTime          @default(now())

  // Relations
  applicationId String
  application   Application       @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

// =============================================================================
// AUDIT AND LOGGING
// =============================================================================

/// Audit log for tracking all important actions
model AuditLog {
  id          String      @id @default(uuid())
  action      AuditAction
  entityType  String      // 'User', 'Application', etc.
  entityId    String
  details     Json?       // Additional context
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  // Relations
  userId      String?
  user        User?       @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  adminId     String?
  admin       User?       @relation("AdminAuditLogs", fields: [adminId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

/// Types of audit actions
enum AuditAction {
  // Authentication
  OTP_REQUESTED
  OTP_VERIFIED
  OTP_FAILED
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  SESSION_CREATED
  SESSION_REVOKED
  
  // User Management
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_ROLE_CHANGED
  
  // Application Management
  APPLICATION_CREATED
  APPLICATION_UPDATED
  APPLICATION_SUBMITTED
  APPLICATION_STATUS_CHANGED
  APPLICATION_REVIEWED
  APPLICATION_ACCEPTED
  APPLICATION_REJECTED
  APPLICATION_SHORTLISTED
  APPLICATION_WITHDRAWN
  
  // Admin Actions
  ADMIN_VIEWED_APPLICATION
  ADMIN_EXPORTED_DATA
  ADMIN_BULK_ACTION
}

// =============================================================================
// EMAIL AND NOTIFICATION MODELS
// =============================================================================

/// Email queue for async email sending
model EmailQueue {
  id          String      @id @default(uuid())
  to          String
  subject     String
  template    String
  data        Json
  status      EmailStatus @default(PENDING)
  attempts    Int         @default(0)
  maxAttempts Int         @default(3)
  error       String?
  sentAt      DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([status])
  @@index([createdAt])
}

enum EmailStatus {
  PENDING
  SENDING
  SENT
  FAILED
}

// =============================================================================
// SYSTEM SETTINGS
// =============================================================================

/// Application season settings
model SeasonSettings {
  id                    String    @id @default(uuid())
  season                String    @unique
  applicationOpenDate   DateTime
  applicationCloseDate  DateTime
  reviewStartDate       DateTime?
  interviewStartDate    DateTime?
  announcementDate      DateTime?
  isActive              Boolean   @default(false)
  maxApplications       Int       @default(500)
  currentApplications   Int       @default(0)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([season])
  @@index([isActive])
}

// =============================================================================
// EXISTING CONTENT MODELS (Preserved from original schema)
// =============================================================================

// Team Members
model TeamMember {
  id        String   @id @default(uuid())
  name      String
  role      String
  category  String   // 'Current Team', 'Mentors', 'Alumni'
  year      String?  // Year of participation
  bio       String?
  image     String?
  linkedIn  String?
  github    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// News Articles
model NewsArticle {
  id          String   @id @default(uuid())
  title       String
  excerpt     String
  content     String?
  category    String   // 'Competition', 'Outreach', 'Alumni', 'Partnership', 'Workshop'
  date        DateTime
  readTime    String
  author      String
  image       String?
   tags        Json     // JSON array of tags
  featured    Boolean  @default(false)
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Competition Timeline
model Competition {
  id           String   @id @default(uuid())
  year         String
  location     String
  theme        String
  achievement  String
   highlights   Json     // JSON array of highlights
  ranking      Int?
  teamSize     Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Resources/Learning Materials
model Resource {
  id          String   @id @default(uuid())
  category    String   // 'robotics', 'programming', 'mechanical', 'electrical', 'competition', 'stem'
  type        String   // 'guide', 'video', 'tutorial', 'course'
  title       String
  description String
  difficulty  String   // 'beginner', 'intermediate', 'advanced', 'all'
  duration    String
  format      String   // 'PDF', 'Video', 'Interactive', etc.
  link        String
  featured    Boolean  @default(false)
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Impact Stories/Testimonials
model ImpactStory {
  id        String   @id @default(uuid())
  name      String
  role      String
  year      String   // Year as team member
  story     String
  impact    String   // Short impact description
  image     String?
  featured  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Milestones/Achievements
model Milestone {
  id          String   @id @default(uuid())
  number      String   // e.g., "500+", "85%"
  label       String   // e.g., "Students Trained"
  description String?
  category    String?  // Optional category for grouping
  order       Int      @default(0) // For ordering display
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Partners/Sponsors
model Partner {
  id          String   @id @default(uuid())
  name        String
  description String?
  logo        String?
  website     String?
  type        String   // 'sponsor', 'partner', 'collaborator'
  level       String?  // 'gold', 'silver', 'bronze', etc.
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Outreach Programs
model OutreachProgram {
  id            String   @id @default(uuid())
  title         String
  description   String
  beneficiaries String   // e.g., "50+ schools", "200+ students monthly"
  icon          String?  // Icon identifier
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Quick Start Guides
model QuickStartGuide {
  id          String   @id @default(uuid())
  title       String
  description String
  icon        String   // Icon identifier
  color       String   // Color class
   items       Json     // JSON array of guide items
  order       Int      @default(0)
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// External Links
model ExternalLink {
  id          String   @id @default(uuid())
  title       String
  description String
  url         String
  icon        String   // Icon identifier
  category    String?  // Optional category
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Site Statistics
model SiteStat {
  id        String   @id @default(uuid())
  key       String   @unique // e.g., 'years_active', 'students_impacted'
  value     Int
  suffix    String?  // e.g., '+', '%'
  label     String
  icon      String?  // Icon identifier
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
