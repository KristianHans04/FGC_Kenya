// Streamlined Schema - Removing unnecessary JOIN tables
// This is a proposed schema to reduce complexity

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// STREAMLINED USER MODEL - No separate UserRole table
// =============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  firstName     String?
  lastName      String?
  phone         String?
  school        String?
  
  // Role fields (no separate table needed)
  role          Role      @default(USER)
  cohort        String?   // e.g., "FGC2025", null for admins
  roleAssignedAt DateTime @default(now())
  roleAssignedBy String?  // User ID who assigned the role
  roleNotes     String?   // Admin notes about role assignment
  
  // Previous roles tracking (as JSON)
  roleHistory   Json?     // Array of {role, cohort, assignedAt, assignedBy, endedAt}
  
  // Status fields
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  otpCodes      OTPCode[]
  sessions      Session[]
  applications  Application[]
  auditLogs     AuditLog[]    @relation("UserAuditLogs")
  adminActions  AuditLog[]    @relation("AdminAuditLogs")
  
  // Email relationships
  sentEmails    Email[]       @relation("SentEmails")
  receivedEmails Email[]      @relation("ReceivedEmails")
  emailDrafts   EmailDraft[]
  emailCampaigns EmailCampaign[] @relation("CreatedCampaigns")
  
  // Media relationships
  articles      MediaArticle[] @relation("AuthorArticles")
  reviewedArticles MediaArticle[] @relation("ReviewedArticles")
  
  // Payment tracking
  payments      Payment[]
  
  // Application forms created (for admins)
  createdForms  ApplicationForm[]

  @@index([email])
  @@index([role])
  @@index([cohort])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MENTOR
  STUDENT
  ALUMNI
  USER
}

// =============================================================================
// STREAMLINED EMAIL SYSTEM - No separate EmailLabel table
// =============================================================================

model Email {
  id          String      @id @default(uuid())
  subject     String
  body        String      // Rich text HTML
  plainText   String?
  
  // Recipients
  toEmails    String[]
  ccEmails    String[]
  bccEmails   String[]
  
  // Labels as array instead of separate table
  labels      String[]    @default(["INBOX"])
  
  // Metadata
  isRead      Boolean     @default(false)
  isStarred   Boolean     @default(false)
  isArchived  Boolean     @default(false)
  isDeleted   Boolean     @default(false)
  isDraft     Boolean     @default(false)
  
  // Threading
  threadId    String?
  replyToId   String?
  
  // Attachments
  attachments Json?
  
  sentAt      DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  senderId    String
  sender      User        @relation("SentEmails", fields: [senderId], references: [id])
  
  recipientId String?
  recipient   User?       @relation("ReceivedEmails", fields: [recipientId], references: [id])
  
  campaignId  String?
  campaign    EmailCampaign? @relation(fields: [campaignId], references: [id])
  
  @@index([senderId])
  @@index([recipientId])
  @@index([threadId])
  @@index([sentAt])
}

model EmailDraft {
  id          String      @id @default(uuid())
  subject     String?
  body        String?
  toEmails    String[]
  ccEmails    String[]
  bccEmails   String[]
  attachments Json?
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model EmailCampaign {
  id          String      @id @default(uuid())
  name        String
  description String?
  status      CampaignStatus @default(DRAFT)
  
  targetGroup Json        // Targeting criteria
  subject     String
  body        String
  
  scheduledAt DateTime?
  sentAt      DateTime?
  
  sentCount   Int         @default(0)
  openCount   Int         @default(0)
  clickCount  Int         @default(0)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  createdById String
  createdBy   User        @relation("CreatedCampaigns", fields: [createdById], references: [id])
  
  emails      Email[]
  
  @@index([status])
  @@index([scheduledAt])
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}

// =============================================================================
// MEDIA SYSTEM
// =============================================================================

model MediaArticle {
  id          String      @id @default(uuid())
  slug        String      @unique
  title       String
  excerpt     String?
  content     String
  coverImage  String?
  
  status      ArticleStatus @default(DRAFT)
  
  metaTitle   String?
  metaDescription String?
  tags        String[]
  
  viewCount   Int         @default(0)
  likes       Int         @default(0)
  shares      Int         @default(0)
  
  publishedAt DateTime?
  featuredAt  DateTime?
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  authorId    String
  author      User        @relation("AuthorArticles", fields: [authorId], references: [id])
  
  reviewedById String?
  reviewedBy  User?       @relation("ReviewedArticles", fields: [reviewedById], references: [id])
  reviewedAt  DateTime?
  reviewNotes String?
  
  cohortRestriction String?
  
  revisions   MediaRevision[]
  
  @@index([slug])
  @@index([status])
  @@index([authorId])
  @@index([publishedAt])
  @@index([cohortRestriction])
}

enum ArticleStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  PUBLISHED
  REJECTED
  ARCHIVED
}

model MediaRevision {
  id          String      @id @default(uuid())
  content     String
  changes     Json?
  createdAt   DateTime    @default(now())
  
  articleId   String
  article     MediaArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  @@index([articleId])
}

// =============================================================================
// STREAMLINED APPLICATION SYSTEM - Status history as JSON
// =============================================================================

model ApplicationForm {
  id          String      @id @default(uuid())
  season      String      @unique
  title       String
  description String?
  
  fields      Json
  
  isActive    Boolean     @default(false)
  isDuplicate Boolean     @default(false)
  duplicatedFrom String?
  
  openDate    DateTime
  closeDate   DateTime
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  createdById String
  createdBy   User        @relation(fields: [createdById], references: [id])
  
  applications Application[]
  
  @@index([season])
  @@index([isActive])
}

model Application {
  id              String            @id @default(uuid())
  season          String            
  status          ApplicationStatus @default(DRAFT)
  
  // Status history as JSON instead of separate table
  statusHistory   Json?             // Array of {status, changedAt, changedBy, notes}
  
  responses       Json
  
  // Personal Information
  firstName       String
  lastName        String
  email           String
  phone           String
  dateOfBirth     DateTime
  gender          String?
  nationality     String            @default("Kenyan")
  
  // Educational Information
  school          String
  grade           String
  county          String
  
  // Documents
  resumeUrl       String?
  recommendationUrl String?
  portfolioUrl    String?
  
  // Consent
  parentConsent   Boolean           @default(false)
  termsAccepted   Boolean           @default(false)
  parentEmail     String?
  parentPhone     String?
  
  // Review process
  reviewNotes     String?
  reviewedBy      String?
  reviewedAt      DateTime?
  
  // Shortlisting
  shortlistRank   Int?
  shortlistNotes  String?
  
  // Interview
  interviewDate   DateTime?
  interviewScore  Float?
  interviewNotes  String?
  
  // Final selection
  finalRank       Int?
  selectionNotes  String?
  
  // Rejection
  rejectionReason String?
  rejectionFeedback String?
  
  // Timestamps
  submittedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  formId          String
  form            ApplicationForm   @relation(fields: [formId], references: [id])
  
  @@unique([userId, season])
  @@index([status])
  @@index([season])
  @@index([submittedAt])
  @@index([shortlistRank])
  @@index([finalRank])
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  SHORTLISTED
  INTERVIEW_SCHEDULED
  INTERVIEWED
  ACCEPTED
  REJECTED
  WAITLISTED
  WITHDRAWN
}

// =============================================================================
// PAYMENT TRACKING
// =============================================================================

model Payment {
  id          String      @id @default(uuid())
  amount      Float
  currency    String      @default("KES")
  purpose     String
  
  method      String?
  reference   String?     @unique
  
  status      PaymentStatus @default(PENDING)
  
  metadata    Json?
  
  paidAt      DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  userId      String?
  user        User?       @relation(fields: [userId], references: [id])
  
  @@index([status])
  @@index([purpose])
  @@index([paidAt])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// =============================================================================
// AUTHENTICATION SUPPORT MODELS
// =============================================================================

model OTPCode {
  id        String      @id @default(uuid())
  code      String
  type      OTPType     @default(LOGIN)
  expiresAt DateTime
  used      Boolean     @default(false)
  usedAt    DateTime?
  attempts  Int         @default(0)
  createdAt DateTime    @default(now())
  
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, code])
  @@index([expiresAt])
}

enum OTPType {
  LOGIN
  VERIFY_EMAIL
  ACCOUNT_RECOVERY
}

model Session {
  id           String    @id @default(uuid())
  token        String    @unique
  refreshToken String?   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  isValid      Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// =============================================================================
// AUDIT AND LOGGING
// =============================================================================

model AuditLog {
  id          String      @id @default(uuid())
  action      AuditAction
  entityType  String
  entityId    String
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())
  
  userId      String?
  user        User?       @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  adminId     String?
  admin       User?       @relation("AdminAuditLogs", fields: [adminId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

enum AuditAction {
  // Authentication
  OTP_REQUESTED
  OTP_VERIFIED
  OTP_FAILED
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  SESSION_CREATED
  SESSION_REVOKED
  
  // User Management
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_ROLE_CHANGED
  USER_ROLE_ASSIGNED
  USER_ROLE_REVOKED
  
  // Application Management
  APPLICATION_CREATED
  APPLICATION_UPDATED
  APPLICATION_SUBMITTED
  APPLICATION_STATUS_CHANGED
  APPLICATION_REVIEWED
  APPLICATION_ACCEPTED
  APPLICATION_REJECTED
  APPLICATION_SHORTLISTED
  APPLICATION_WITHDRAWN
  
  // Email Actions
  EMAIL_SENT
  EMAIL_DRAFTED
  EMAIL_CAMPAIGN_CREATED
  EMAIL_CAMPAIGN_SENT
  
  // Media Actions
  ARTICLE_CREATED
  ARTICLE_UPDATED
  ARTICLE_PUBLISHED
  ARTICLE_APPROVED
  ARTICLE_REJECTED
  
  // Admin Actions
  ADMIN_VIEWED_USER
  ADMIN_VIEWED_APPLICATION
  ADMIN_EXPORTED_DATA
  ADMIN_BULK_ACTION
  ADMIN_VIEWED_PAYMENTS
  
  // Super Admin Actions
  SUPER_ADMIN_VIEWED_ALL_USERS
  SUPER_ADMIN_TRACKED_PAYMENT
}

// =============================================================================
// EMAIL QUEUE
// =============================================================================

model EmailQueue {
  id          String      @id @default(uuid())
  to          String
  subject     String
  template    String
  data        Json
  status      EmailQueueStatus @default(PENDING)
  attempts    Int         @default(0)
  maxAttempts Int         @default(3)
  error       String?
  sentAt      DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([status])
  @@index([createdAt])
}

enum EmailQueueStatus {
  PENDING
  SENDING
  SENT
  FAILED
}

// =============================================================================
// EXISTING CONTENT MODELS
// =============================================================================

model TeamMember {
  id        String   @id @default(uuid())
  name      String
  role      String
  category  String
  year      String?
  bio       String?
  image     String?
  linkedIn  String?
  github    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NewsArticle {
  id          String   @id @default(uuid())
  title       String
  excerpt     String
  content     String?
  category    String
  date        DateTime
  readTime    String
  author      String
  image       String?
  tags        Json
  featured    Boolean  @default(false)
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Competition {
  id           String   @id @default(uuid())
  year         String
  location     String
  theme        String
  achievement  String
  highlights   Json
  ranking      Int?
  teamSize     Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Resource {
  id          String   @id @default(uuid())
  category    String
  type        String
  title       String
  description String
  difficulty  String
  duration    String
  format      String
  link        String
  featured    Boolean  @default(false)
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ImpactStory {
  id        String   @id @default(uuid())
  name      String
  role      String
  year      String
  story     String
  impact    String
  image     String?
  featured  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Milestone {
  id          String   @id @default(uuid())
  number      String
  label       String
  description String?
  category    String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Partner {
  id          String   @id @default(uuid())
  name        String
  description String?
  logo        String?
  website     String?
  type        String
  level       String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model OutreachProgram {
  id            String   @id @default(uuid())
  title         String
  description   String
  beneficiaries String
  icon          String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model QuickStartGuide {
  id          String   @id @default(uuid())
  title       String
  description String
  icon        String
  color       String
  items       Json
  order       Int      @default(0)
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ExternalLink {
  id          String   @id @default(uuid())
  title       String
  description String
  url         String
  icon        String
  category    String?
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SiteStat {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Int
  suffix    String?
  label     String
  icon      String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}